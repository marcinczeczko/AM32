name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # -----------------------------------------------------------------------------
  # JOB 1: MATRIX GENERATOR
  # Parses CMakeLists.txt and targets.h to generate a dynamic build list.
  # -----------------------------------------------------------------------------
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Generate Target Matrix
      id: set-matrix
      run: |
        python3 -c '
        import re
        import json
        import os

        # --- 1. PARSE SKIP LIST FROM CMakeLists.txt ---
        skip_list = set()
        try:
            with open("CMakeLists.txt", "r") as f:
                cmake_content = f.read()
                # Finds: set(TARGET_SKIP_LIST "A" "B" ...) across multiple lines
                match = re.search(r"set\s*\(\s*TARGET_SKIP_LIST\s+([^)]+)\)", cmake_content, re.DOTALL)
                if match:
                    # Split by whitespace and clean quotes
                    raw_items = match.group(1).split()
                    for item in raw_items:
                        clean_item = item.strip("\"\'")
                        if clean_item:
                            skip_list.add(clean_item)
            print(f"Skipping targets from CMakeLists: {skip_list}")
        except FileNotFoundError:
            print("Warning: CMakeLists.txt not found, no skip list loaded.")

        # --- 2. PARSE targets.h (SIMPLE SCAN) ---
        targets = []
        PRESET_ARM = "build-arm"
        PRESET_RISCV = "build-wch"

        # Regex to find: #define FILE_NAME "MY_TARGET"
        re_filename = re.compile(r"^\s*#define\s+FILE_NAME\s+\"([^\"]+)\"")

        try:
            with open("Inc/targets.h", "r") as f:
                for line in f:
                    match = re_filename.search(line)
                    if match:
                        board_name = match.group(1)

                        # Check Skip List
                        if board_name in skip_list:
                            print(f"{board_name} is skipped")
                            continue

                        # Determine MCU Architecture - FIXME: there should be a better way...
                        if "_V203" in board_name or "CH32" in board_name: 
                            preset = PRESET_RISCV
                            configure = "wch-riscv"
                        else:
                            preset = PRESET_ARM
                            configure = "arm"
                            
                        targets.append({
                            "name": board_name,
                            "configure": configure,
                            "build_preset": preset
                        })

        except FileNotFoundError:
            print("Error: Inc/targets.h not found")
            exit(1)

        # Output JSON
        if not targets:
             print("No targets found!")
             exit(1)

        matrix_json = json.dumps({"include": targets})
        print(f"Generated Matrix for {len(targets)} targets.")
        
        with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"matrix={matrix_json}")
        '

  # -----------------------------------------------------------------------------
  # JOB 2: DYNAMIC BUILD
  # -----------------------------------------------------------------------------
  build:
    needs: setup-matrix
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}

    steps:
    - uses: actions/checkout@v4
      with: { submodules: recursive }
    
    - name: Install Tools
      run: sudo apt-get update && sudo apt-get install -y ninja-build cmake python3

    - name: Restore Tools Cache
      uses: actions/cache@v4
      with:
        path: tools/
        key: ${{ runner.os }}-am32-tools-${{ hashFiles('cmake/manage_tools.cmake') }}
        restore-keys: ${{ runner.os }}-am32-tools-

    - name: Setup toolset
      run: cmake -P cmake/manage_tools.cmake
    
    - name: Configure
      run: cmake --preset ${{ matrix.configure }}

    - name: Build Target
      run: cmake --build --preset ${{ matrix.build_preset }} --target ${{ matrix.name }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: build/**/*.hex