name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # -----------------------------------------------------------------------------
  # JOB 1: MATRIX GENERATOR
  # -----------------------------------------------------------------------------
  setup-matrix:               
    runs-on: ubuntu-latest   
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate Target Matrix
        id: set-matrix
        run: |
          python3 - << 'EOF'
          import re
          import json
          import os

          # --- 1. PARSE SKIP LIST FROM CMakeLists.txt ---
          skip_list = set()
          try:
              with open("CMakeLists.txt", "r") as f:
                  cmake_content = f.read()
                  match = re.search(r"set\s*\(\s*TARGET_SKIP_LIST\s+([^)]+)\)", cmake_content, re.DOTALL)
                  if match:
                      content = match.group(1)
                      # Find strings inside quotes
                      items = re.findall(r'"([^"]*)"', content)
                      for item in items:
                          # Convert to UPPERCASE for case-insensitive comparison
                          skip_list.add(item.strip().upper())
                            
              print(f"Skipping targets from CMakeLists: {skip_list}")
          except FileNotFoundError:
              print("Warning: CMakeLists.txt not found, no skip list loaded.")

          # --- 2. PARSE targets.h ---
          targets = []
          PRESET_ARM = "build-arm"
          PRESET_RISCV = "build-wch"

          re_filename = re.compile(r"^\s*#define\s+FILE_NAME\s+\"([^\"]+)\"")

          try:
              with open("Inc/targets.h", "r") as f:
                  for line in f:
                      match = re_filename.search(line)
                      if match:
                          board_name_raw = match.group(1)
                          board_name = board_name_raw.strip()

                          if not board_name: 
                              continue

                          # Check against skip list using UPPERCASE
                          if board_name.upper() in skip_list:
                              print(f"Skipping {board_name_raw} (found in skip list)")
                              continue
                          
                          # Architecture Logic
                          if "_V203" in board_name_raw or "CH32" in board_name_raw: 
                              preset = PRESET_RISCV
                              configure = "wch-riscv"
                          else:
                              preset = PRESET_ARM
                              configure = "arm"
                              
                          # Use raw name for the actual build target command
                          targets.append({
                              "name": board_name_raw, 
                              "configure": configure,
                              "build_preset": preset
                          })

          except FileNotFoundError:
              print("Error: Inc/targets.h not found")
              exit(1)

          if not targets:
              print("No targets found!")
              exit(1)

          matrix_json = json.dumps({"include": targets})
          print(f"Generated Matrix for {len(targets)} targets.")
          
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"matrix={matrix_json}")
          EOF

  # -----------------------------------------------------------------------------
  # JOB 2: DYNAMIC BUILD
  # -----------------------------------------------------------------------------
  build:
    needs: setup-matrix
    name: AM32_${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
        with: { submodules: recursive }
      
      - name: Install Tools
        run: sudo apt-get update && sudo apt-get install -y ninja-build cmake python3

      - name: Restore Tools Cache
        uses: actions/cache@v4
        with:
          path: tools/
          key: ${{ runner.os }}-am32-tools-${{ hashFiles('cmake/manage_tools.cmake') }}
          restore-keys: ${{ runner.os }}-am32-tools-

      - name: Setup toolset
        run: cmake -P cmake/manage_tools.cmake

      # 1. GENERATE VERSION SUFFIX
      # If it's a tag, use the tag name (v2.20).
      # If it's a generic commit, use the short Git Hash (7 chars).
      - name: Determine Version
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git rev-parse --short HEAD)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Computed version suffix: $VERSION"

      - name: Configure
        run: cmake --preset ${{ matrix.configure }}

      - name: Build Target
        run: cmake --build --preset ${{ matrix.build_preset }} --target ${{ matrix.name }}

      # 2. RENAME & FLATTEN
      # Find the built hex file (which CMake named AM32_TARGET_X.XX.hex)
      # Rename it to include the Git Hash for clarity, and move it to a clean folder.
      - name: Prepare Artifact
        run: |
          mkdir -p staging
          
          # Find the generated hex file (regardless of CMake's internal versioning)
          # We search in build directories
          HEX_FILE=$(find build -name "*.hex" | head -n 1)
          
          if [ -z "$HEX_FILE" ]; then
            echo "Error: No .hex file found!"
            exit 1
          fi
          
          # New Name: AM32_TARGET_GITHASH.hex
          NEW_NAME="AM32_${{ matrix.name }}_${{ env.VERSION }}.hex"
          
          cp "$HEX_FILE" "staging/$NEW_NAME"
          echo "Prepared: staging/$NEW_NAME"

      # 3. UPLOAD (Clean Name & Flat Structure)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # This controls the label in the GitHub UI list
          name: AM32_${{ matrix.name }}_${{ env.VERSION }}
          # Uploading the file directly (not a wildcard path) flattens the zip
          path: staging/*.hex